<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>NutriSnap</title>
  
  <style>
    /* --- CSS (Sama seperti sebelum ini) --- */
    :root {
      --bg: #f0f7ff; --card: #ffffff;
      --primary: #377CFF; --primary-gradient: linear-gradient(135deg, #377CFF 0%, #00C6FF 100%);
      --soft: #eef6ff; --muted: #8898aa;
      --accent: #2dce89; --accent-gradient: linear-gradient(135deg, #2dce89 0%, #2dcecc 100%);
      --danger: #f5365c; --facebook: #1877F2;
      --radius: 16px; font-family: Inter, sans-serif;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: #32325d; -webkit-font-smoothing: antialiased; }
    .hidden { display: none !important; }
    #app { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* Topbar */
    .topbar { height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 18px; background: var(--primary-gradient); box-shadow: 0 4px 6px rgba(50,50,93,0.11); z-index: 100; color: white; }
    .brand { font-weight: 800; font-size: 22px; }
    .user-icon { width: 38px; height: 38px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; overflow: hidden; }
    .user-icon img { width: 100%; height: 100%; object-fit: cover; }

    /* Main Area */
    .screens { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; }
    .screen { display: none; animation: fadeIn 0.4s ease; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Login UI */
    .login-card { background: white; padding: 30px 20px; border-radius: var(--radius); box-shadow: 0 10px 25px rgba(50,50,93,0.15); text-align: center; max-width: 400px; margin: 40px auto; }
    .login-card h1 { margin-top: 0; color: var(--primary); }
    button { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .primary { background: var(--primary-gradient); color: white; }
    .fb-btn { background: var(--facebook); color: white; }
    .secondary { background: var(--soft); color: var(--primary); }
    .danger-btn { background: #fff0f3; color: var(--danger); }
    input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #e0e6ed; border-radius: 10px; font-size: 16px; }

    /* Dashboard */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 25px; }
    .stat-card { background: white; padding: 15px; border-radius: var(--radius); box-shadow: 0 4px 12px rgba(50,50,93,0.1); text-align: center; position: relative; overflow: hidden; }
    .stat-card.full-width { grid-column: span 2; background: linear-gradient(to right bottom, #fff, #f8fbff); }
    .stat-card::after { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--primary-gradient); }
    .stat-val { font-size: 24px; font-weight: 800; color: #32325d; }
    .stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; font-weight: 600; text-transform: uppercase; }

    /* Nav */
    .bottombar { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: white; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.04); z-index: 900; }
    .nav-btn { flex: 1; background: none; border: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #adb5bd; font-size: 11px; font-weight: 600; gap: 5px; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }
    .fab-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; border-radius: 50%; background: var(--accent-gradient); color: white; border: none; box-shadow: 0 10px 20px rgba(45, 206, 137, 0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    
    /* Lists */
    .list-item { background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; }
    
    /* Upload */
    .upload-box { background:#f6f9fc; height:200px; border-radius:10px; display:flex; align-items:center; justify-content:center; margin-bottom:20px; border:2px dashed #e2e8f0; position:relative; overflow:hidden; }
    .preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
  </style>
</head>
<body>

  <div id="app">
    <header class="topbar">
      <div class="brand">NutriSnap</div>
      <div id="userIcon" class="user-icon hidden" data-nav="profile">A</div>
    </header>

    <main class="screens">
      <!-- Login -->
      <section id="login" class="screen active">
        <div class="login-card">
          <h1>Selamat Datang</h1>
          <p>Sila log masuk untuk meneruskan.</p>
          <button id="googleBtn" class="primary">
             <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10c5.35 0 9.25-3.67 9.25-9.09c0-1.15-.15-1.81-.15-1.81z"/></svg>
             Masuk dengan Google
          </button>
          <button id="fbBtn" class="fb-btn">
             <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10 10 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z"/></svg>
             Masuk dengan Facebook
          </button>
          <div id="loginStatus" style="margin-top:10px; font-weight:bold; color:#377CFF;"></div>
        </div>
      </section>

      <!-- Home -->
      <section id="home" class="screen">
        <h3>Ringkasan Hari Ini</h3>
        <div class="stats-grid">
            <div class="stat-card full-width"><div class="stat-val" id="calBalance">0</div><div class="stat-label">Kalori</div></div>
            <div class="stat-card"><div class="stat-val" id="protBalance">0</div><div class="stat-label">Protein</div></div>
            <div class="stat-card"><div class="stat-val" id="carbBalance">0</div><div class="stat-label">Karbo</div></div>
        </div>
        <h3>Log Makanan Terkini</h3>
        <div id="recentMealsList" class="history-list"></div>
      </section>

      <!-- Onboarding -->
      <section id="onboarding" class="screen">
        <div class="login-card">
            <h2>Matlamat Anda</h2>
            <input type="number" id="onboardStartWeight" placeholder="Berat Semasa (kg)">
            <input type="number" id="onboardGoalWeight" placeholder="Matlamat (kg)">
            <button class="primary" id="btnSaveOnboarding">Simpan</button>
        </div>
      </section>

      <!-- Upload -->
      <section id="upload" class="screen">
        <div class="login-card">
          <h2>Analisis</h2>
          <div class="upload-box"><img id="uploadPreview" class="preview-img hidden"><div id="uploadPlaceholder">ðŸ“¸</div></div>
          <input type="file" id="cameraInput" accept="image/*" style="display:none">
          <button class="primary" id="btnSnap">Ambil Gambar</button>
          <button class="secondary" id="btnCancelUpload">Batal</button>
        </div>
      </section>

      <!-- Profile -->
      <section id="profile" class="screen">
        <div class="login-card">
            <div class="user-icon" style="margin:0 auto 20px;">A</div>
            <h3 id="profileName">User</h3>
            <p style="color:#888;" id="profileEmail">user@email.com</p>
            <button class="danger-btn" id="btnLogout">Log Keluar</button>
        </div>
      </section>
      
      <!-- Placeholder for other screens -->
      <section id="analysis" class="screen"><h3>Diari</h3><div id="mealsContainer"></div></section>
      <section id="weight" class="screen"><h3>Berat</h3><div id="weightHistory"></div></section>

    </main>
    
    <button id="fabBtn" class="fab-btn hidden" data-nav="upload">+</button>

    <nav class="bottombar hidden" id="mainNav">
      <button class="nav-btn active" data-nav="home"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8z"/></svg><span>Utama</span></button>
      <button class="nav-btn" data-nav="analysis"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg><span>Diari</span></button>
      <div class="nav-spacer"></div>
      <button class="nav-btn" data-nav="weight"><svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9s9-4.03 9-9s-4.03-9-9-9zm-1.5 3h3V9h-3V6zm0 10.5V12h3v4.5h-3z"/></svg><span>Berat</span></button>
      <button class="nav-btn" data-nav="profile"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4s-4 1.79-4 4s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>Profil</span></button>
    </nav>
  </div>

  <!-- SINGLE ROBUST SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, FacebookAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- KEYS ---
    const firebaseConfig = {
      apiKey: "AIzaSyC9hya7EGpzu9Qn-bcjcwVpgy-_K7NR47A",
      authDomain: "nutrisnap-34c6b.firebaseapp.com",
      projectId: "nutrisnap-34c6b",
      storageBucket: "nutrisnap-34c6b.firebasestorage.app",
      messagingSenderId: "427310632230",
      appId: "1:427310632230:web:78e2943728aec2987ac5e7"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // --- STATE ---
    let currentUser = null;
    let mealLogs = [];

    // --- AUTH LISTENER (AUTO LOGIN) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Auto Login Detected:", user.email);
            handleLoginSuccess(user);
        } else {
            console.log("No User");
        }
    });

    // --- UI FUNCTIONS ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id===id));
        const hide = ['login','onboarding'].includes(id);
        const els = [document.getElementById('mainNav'), document.getElementById('fabBtn'), document.getElementById('userIcon')];
        els.forEach(el => el.classList.toggle('hidden', hide));
        
        if (id === 'home') renderHome();
    }

    function handleLoginSuccess(user) {
        currentUser = user;
        document.getElementById('profileName').innerText = user.displayName;
        document.getElementById('profileEmail').innerText = user.email;
        if(user.photoURL) document.querySelector('.user-icon').innerHTML = `<img src="${user.photoURL}">`;
        
        // Start Data Stream
        subscribeToData(user.uid);

        // FORCE NAVIGATION
        if(localStorage.getItem('userGoal')) {
            showScreen('home');
        } else {
            showScreen('onboarding');
        }
    }

    // --- BUTTON ACTIONS ---
    
    // 1. GOOGLE LOGIN
    document.getElementById('googleBtn').onclick = async () => {
        const btn = document.getElementById('googleBtn');
        const stat = document.getElementById('loginStatus');
        btn.innerText = "Menghubungi Google...";
        stat.innerText = "Sila pilih akaun di popup...";
        
        try {
            const result = await signInWithPopup(auth, new GoogleAuthProvider());
            // FORCE SUCCESS IMMEDIATELY
            stat.innerText = "Berjaya! Mengalih...";
            handleLoginSuccess(result.user);
        } catch (error) {
            console.error(error);
            stat.innerText = "Ralat: " + error.code;
            // Fallback for domain error
            if(error.code === 'auth/unauthorized-domain') {
                 alert("Domain Blocked. Using Offline Mode.");
                 enterOfflineMode();
            }
        }
    };

    // 2. FACEBOOK LOGIN
    document.getElementById('fbBtn').onclick = async () => {
        try {
            const result = await signInWithPopup(auth, new FacebookAuthProvider());
            handleLoginSuccess(result.user);
        } catch (error) {
            alert("Facebook Error: " + error.message);
        }
    };

    // 3. OFFLINE MODE
    function enterOfflineMode() {
        const mock = { uid: "offline_1", displayName: "Offline User", email: "local@app", photoURL: null };
        handleLoginSuccess(mock);
    }

    // --- DATA LOGIC ---
    function subscribeToData(uid) {
        if(uid.startsWith('offline')) return; // Skip firestore for offline
        
        const q = query(collection(db, 'users', uid, 'meals'), orderBy('date', 'desc'), limit(50));
        onSnapshot(q, (snap) => {
            mealLogs = [];
            snap.forEach(d => mealLogs.push(d.data()));
            renderHome();
        });
    }

    function renderHome() {
        const sum = (k) => mealLogs.reduce((a,b)=>a+(b[k]||0),0);
        document.getElementById('calBalance').innerText = sum('calories');
        document.getElementById('protBalance').innerText = sum('protein');
        document.getElementById('carbBalance').innerText = sum('carbs');
    }

    // --- OTHER LISTENERS ---
    document.getElementById('btnLogout').onclick = async () => {
        await signOut(auth);
        window.location.reload();
    };

    document.querySelectorAll('[data-nav]').forEach(el => {
        el.addEventListener('click', () => showScreen(el.dataset.nav));
    });

    document.getElementById('btnSaveOnboarding').onclick = () => {
        localStorage.setItem('userGoal', document.getElementById('onboardGoalWeight').value);
        showScreen('home');
    };

    document.getElementById('btnSnap').onclick = () => document.getElementById('cameraInput').click();
    
    document.getElementById('cameraInput').onchange = (e) => {
        // Camera simulation logic
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('uploadPreview').src = ev.target.result;
                document.getElementById('uploadPreview').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                
                setTimeout(() => {
                    if(confirm("AI: Nasi Lemak (450 kcal). Simpan?")) {
                        const data = { name: "Nasi Lemak", calories: 450, protein: 12, carbs: 60, date: new Date().toISOString().split('T')[0] };
                        if(currentUser && !currentUser.uid.startsWith('offline')) {
                            addDoc(collection(db, 'users', currentUser.uid, 'meals'), data);
                        } else {
                            mealLogs.push(data); renderHome();
                        }
                        showScreen('home');
                    }
                }, 1000);
            }
            reader.readAsDataURL(file);
        }
    };
    
    document.getElementById('btnCancelUpload').onclick = () => showScreen('home');

  </script>
</body>
</html>
